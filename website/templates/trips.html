<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Trips</title>
        <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
        <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    </head>
    <body class="sb-nav-fixed">
        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <nav class="sb-sidenav accordion sb-sidenav-light" id="sidenavAccordion">

                    <div class="sidebar-logo-container" style="text-align: center; padding: 1.5rem 0;">
                        <a href="{{ url_for('main.groups') }}">
                            <img src="{{ url_for('static', filename='img/colby_logo.png') }}" alt="Colby logo" style="height: 50px; width: auto;">
                        </a>
                    </div>

                    <div class="sb-sidenav-menu">
                        <div class="nav">
                            <a class="nav-link" href="{{ url_for('main.trips') }}">
                                <div class="sb-nav-link-icon"><i class="fas fa-route"></i></div>
                                Trips
                            </a>
                            <a class="nav-link" href="{{ url_for('main.first_years') }}">
                                <div class="sb-nav-link-icon"><i class="fas fa-user-plus"></i></div>
                                First Years
                            </a>
                            <a class="nav-link" href="{{ url_for('main.groups') }}">
                                <div class="sb-nav-link-icon"><i class="fas fa-users"></i></div>
                                Groups
                            </a>
                        </div>
                    </div>

                    <div class="sb-sidenav-footer">
                        <a class="nav-link" href="{{ url_for('main.settings') }}">
                            <div class="sb-nav-link-icon"><i class="fas fa-cog"></i></div>
                            Settings
                        </a>
                    </div>
                </nav>
            </div>
            <div id="layoutSidenav_content">
                <main>
                    <div class="container-fluid px-4">
                        <h1 class="mt-4">Trips</h1>

                        <!-- Flash Messages for Trips Page -->
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    {% if 'Trip' in message or 'Error' in message or 'CSV' in message %}
                                        <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' if category == 'success' else 'warning' if category == 'warning' else 'info' }} alert-dismissible fade show" role="alert">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                        <div class="action-row">
                            <button class="btn btn-navy" type="button" data-bs-toggle="modal" data-bs-target="#uploadCSVModal">Upload CSV</button>
                            <button class="btn btn-navy" type="button" data-bs-toggle="modal" data-bs-target="#addTripModal"><i class="fas fa-plus me-1"></i> Add a trip</button>
                            <button class="btn btn-navy" type="button" data-bs-toggle="modal" data-bs-target="#removeTripModal">- Remove a trip</button>
                            <form action="{{ url_for('main.export_trip_csv') }}" method="GET" style="display:inline;">
                                <button class="btn btn-navy" type="submit">Export to CSV</button>
                            </form>


                        </div>
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-table me-1"></i>
                                Trips
                            </div>
                            <div class="card-body">
                                <table id="datatablesSimple">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Trip Type</th>
                                            <th>Trip Name</th>
                                            <th>Address</th>
                                            <th>Capacity</th>
                                            <th>Water?</th>
                                            <th>Tents?</th>
                                            <th>Description</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for trip in trips %}
                                        <tr>
                                            <td>{{ trip.id }}</td>
                                            <td>{{ trip.trip_type }}</td>
                                            <td>{{ trip.trip_name }}</td>
                                            <td>{{ trip.address or '' }}</td>
                                            <td>{{ trip.capacity }}</td>
                                            <td>{{ 'Yes' if trip.water else 'No' }}</td>
                                            <td>{{ 'Yes' if trip.tent else 'No' }}</td>
                                            <td>{{ trip.description or '' }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary edit-trip-btn" data-trip-id="{{ trip.id }}" data-bs-toggle="modal" data-bs-target="#addTripModal">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        <div class="modal fade" id="addTripModal" tabindex="-1" aria-labelledby="addTripModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addTripModalLabel">Add New Trip</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="tripForm" action="{{ url_for('main.add_trip') }}" method="POST">
                        <input type="hidden" id="trip_db_id" name="trip_id" value="">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="trip_name" class="form-label">Trip Name*</label>
                                    <input type="text" class="form-control" id="trip_name" name="trip_name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="trip_type" class="form-label">Trip Type*</label>
                                    <select id="trip_type" name="trip_type" class="form-label" required>
                                        <option value="" disabled selected>Select an option</option>
                                        <option value="backpacking">Backpacking</option>
                                        <option value="canoeing">Canoeing</option>
                                        <option value="basecamp">Basecamp</option>
                                        <option value="classic maine camp">Classic Maine Camp</option>
                                        <option value="local exploration">Local Exploration</option>
                                        <option value="specialty basecamp">Specialty Basecamp</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="capacity" class="form-label">Capacity*</label>
                                    <input type="number" class="form-control" id="capacity" name="capacity" min="1" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" name="address">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" value="true" id="water" name="water">
                                        <label class="form-check-label" for="water">
                                            Water Trip
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" value="true" id="tent" name="tent">
                                        <label class="form-check-label" for="tent">
                                            Tent Trip
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                            </div>
                            <small class="text-muted">Fields marked with * are required.</small>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="tripSubmitBtn">Save Trip</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Upload CSV Modal with Column Matching -->
        <div class="modal fade" id="uploadCSVModal" tabindex="-1" aria-labelledby="uploadCSVModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #003366; color: white;">
                <h5 class="modal-title" id="uploadCSVModalLabel">Upload CSV File</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="csvMatchingForm" method="POST" enctype="multipart/form-data" action="{{ url_for('api.process_matched_trips_csv') }}">
                <div class="modal-body">
                    <!-- Instructions Section -->
                    <div class="alert alert-info" role="alert">
                        <h6 class="alert-heading"><i class="fas fa-info-circle"></i> How to Upload a CSV</h6>
                        <ol class="mb-0" style="padding-left: 1.2rem; font-size: 0.9rem;">
                            <li><strong>Select your CSV file</strong> using the file picker below</li>
                            <li><strong>Review the automatic column matching</strong> - the system will try to match your CSV columns to database fields</li>
                            <li><strong>Adjust any incorrect mappings</strong> using the dropdown menus (or select "Skip Column" to ignore a column)</li>
                            <li><strong>Choose an action:</strong>
                                <ul style="margin-top: 0.3rem;">
                                    <li><em>Add New Trips</em> - Only creates new records (skips if Trip Name already exists)</li>
                                    <li><em>Update Existing Trips</em> - Updates existing records based on Trip Name</li>
                                </ul>
                            </li>
                            <li><strong>Click "Upload CSV"</strong> to import your data</li>
                        </ol>
                        <hr style="margin: 0.75rem 0;">
                        <small class="text-muted">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Required fields:</strong> Trip Name, Trip Type, and Capacity must be included in your CSV.
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="csv_file" class="form-label"><strong>Select CSV File</strong></label>
                        <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
                        <small class="form-text text-muted">Your CSV file can have any column names - you'll map them to our database fields in the next step.</small>
                    </div>

                    <div id="columnMatchingContainer" style="display: none;">
                        <hr class="my-4">
                        <h6 class="mb-2"><i class="fas fa-columns"></i> Match CSV Columns to Database Fields</h6>
                        <p class="text-muted" style="font-size: 0.9rem;">
                            For each column in your CSV, select the corresponding database field from the dropdown.
                            The system has automatically suggested matches based on your column names.
                            Select <strong>"-- Skip Column --"</strong> for any columns you don't want to import.
                        </p>
                        <div id="matchingRows"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" id="submitBtn" class="btn text-white" style="background-color:#003366; display: none;">Upload CSV</button>
                </div>
                </form>
            </div>
            </div>
        </div>

        <div class="modal fade" id="removeTripModal" tabindex="-1" aria-labelledby="removeTripModalLabel" aria-hidden="true">
           <div class="modal-dialog">
               <div class="modal-content">
                   <div class="modal-header">
                       <h5 class="modal-title" id="removeTripModalLabel">Remove Trip</h5>
                       <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                   </div>
                   <div class="modal-body">
                       <div class="mb-3">
                           <label for="removeTripSelect" class="form-label">Select Trip to Remove</label>
                           <select class="form-select" id="removeTripSelect" style="width: 100%;">
                               <option value="">Select a trip...</option>
                               {% for trip in trips %}
                                   <option value="{{ trip.id }}">
                                       {{ trip.trip_name }} ({{ trip.trip_type }})
                                   </option>
                               {% endfor %}
                           </select>
                       </div>
                   </div>
                   <div class="modal-footer">
                       <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                       <button type="button" class="btn btn-danger" id="openConfirmTripModalBtn">Next</button>
                   </div>
               </div>
           </div>
       </div>

       <div class="modal fade" id="confirmRemoveTripModal" tabindex="-1" aria-labelledby="confirmRemoveTripModalLabel" aria-hidden="true">
           <div class="modal-dialog">
               <div class="modal-content">
                   <div class="modal-header">
                       <h5 class="modal-title" id="confirmRemoveTripModalLabel">Confirm Removal</h5>
                       <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                   </div>
                   <div class="modal-body">
                       <p>Are you sure you want to remove this trip?</p>
                       <h4 class="text-center text-danger" id="tripNameToRemove"></h4>
                       <p class="text-center text-muted">This action cannot be undone.</p>
                   </div>
                   <div class="modal-footer">
                       <form action="{{ url_for('main.remove_trip') }}" method="POST" class="w-100">
                           <input type="hidden" name="trip_id" id="tripIdToRemove">

                           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                           <button type="submit" class="btn btn-danger float-end">Yes, Remove Trip</button>
                       </form>
                   </div>
               </div>
           </div>
       </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
        <script src="{{ url_for('static', filename='js/datatables-simple-demo.js') }}"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script>
            // Make trip data available globally
            window.tripsData = {{ trips_data_json|safe }};
        </script>
        <script src="{{ url_for('static', filename='js/trips.js') }}"></script>
    </body>
</html>
