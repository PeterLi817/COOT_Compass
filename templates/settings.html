<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>First-Years</title>
        <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
        <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    </head>
    <body class="sb-nav-fixed">
        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <nav class="sb-sidenav accordion sb-sidenav-light" id="sidenavAccordion">

                    <div class="sidebar-logo-container" style="text-align: center; padding: 1.5rem 0;">
                        <a href="{{ url_for('main.groups') }}">
                            <img src="{{ url_for('static', filename='img/colby_logo.png') }}" alt="Colby logo" style="height: 50px; width: auto;">
                        </a>
                    </div>

                    <div class="sb-sidenav-menu">
                        <div class="nav">
                            <a class="nav-link" href="{{ url_for('main.trips') }}">
                                <div class="sb-nav-link-icon"><i class="fas fa-route"></i></div>
                                Trips
                            </a>
                            <a class="nav-link" href="{{ url_for('main.first_years') }}">
                                <div class="sb-nav-link-icon"><i class="fas fa-user-plus"></i></div>
                                First Years
                            </a>
                            <a class="nav-link" href="{{ url_for('main.groups') }}">
                                <div class="sb-nav-link-icon"><i class="fas fa-users"></i></div>
                                Groups
                            </a>
                        </div>
                    </div>

                    <div class="sb-sidenav-footer">
                        <a class="nav-link" href="{{ url_for('main.settings') }}">
                            <div class="sb-nav-link-icon"><i class="fas fa-cog"></i></div>
                            Settings
                        </a>
                    </div>
                </nav>
            </div>
            <div id="layoutSidenav_content">
                <main>
                <div class="container-fluid px-4">
                    <h1 class="mt-4">Settings</h1>

                    <!-- User Info Card -->
                    <div class="card mb-4 w-50 mx-auto shadow-sm">
                        <div class="card-body text-center">
                            <div class="d-flex flex-column align-items-center" id="userRole" data-role="{{ current_user.role }}">
                                <i class="fas fa-user-circle fa-4x mb-3 text-secondary"></i>
                                <h4 class="mb-1">{{ current_user.first_name }} {{ current_user.last_name }}</h4>
                                <p class="text-muted mb-1">{{ current_user.email }}</p>
                                <span class="badge bg-info text-dark mb-3">Role: {{ current_user.role.replace('_', ' ') }}</span>

                                <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger mt-2">
                                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Flash Messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            <div class="mb-3">
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ 'danger' if category in ['error','danger'] else category }} alert-dismissible fade show" role="alert">
                                        {{ message|safe }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endwith %}

                    <!-- Actions Card -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <i class="fas fa-sliders-h me-1"></i> Actions
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-3 d-sm-flex justify-content-sm-center flex-wrap">

                                <a href="#" class="btn btn-primary btn-lg">
                                    <i class="fas fa-map-signs me-2"></i> Show Trips to Students
                                </a>

                                <a href="#" id="editPermissionsBtn" class="btn btn-primary btn-lg">
                                    <i class="fas fa-wrench me-2"></i> Edit Access Permissions
                                </a>

                                <button id="clearDatabaseBtn" class="btn btn-danger">
                                    <i class="fas fa-database me-2"></i> Clear Databases
                                </button>

                            </div>
                        </div>
                    </div>

                </div>
            </main>
            </div>
        </div>

        <!-- Permission Denied Modal -->
        <div class="modal fade" id="permissionDeniedModal" tabindex="-1" aria-labelledby="permissionDeniedModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="permissionDeniedModalLabel">
                            <i class="fas fa-exclamation-triangle me-2"></i>Permission Denied
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <i class="fas fa-lock fa-3x text-danger mb-3"></i>
                        <p class="lead">You do not have permission to perform this action.</p>
                        <p class="text-muted">Only users with the <strong>admin manager</strong> role can access this feature.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View All Users Modal -->
        <div class="modal fade" id="viewUsersModal" tabindex="-1" aria-labelledby="viewUsersModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title text-dark" id="viewUsersModalLabel">
                            <i class="fas fa-users me-2"></i> Users
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="usersLoadingSpinner" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading users...</p>
                        </div>
                        <div id="adminFilterContainer" class="form-check mb-3" style="display:none;">
                            <input class="form-check-input" type="checkbox" id="adminFilterCheckbox" checked>
                            <label class="form-check-label" for="adminFilterCheckbox">Show only Admin & Admin Manager</label>
                        </div>
                        <div id="usersTableContainer" style="display: none;">
                            <table id="datatablesSimple">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Role</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="usersErrorMessage" class="alert alert-danger" style="display: none;" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="usersErrorText">Failed to load users.</span>
                        </div>
                        <div class="alert alert-info small mt-3" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> To add a new admin, the user must first sign in to the app with Google. If they are not showing in the system, ask them to visit the app and sign in first.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit User Role Modal -->
        <div class="modal fade" id="editUserRoleModal" tabindex="-1" aria-labelledby="editUserRoleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title text-dark" id="editUserRoleModalLabel">
                            <i class="fas fa-user-edit me-2"></i>Edit User Role
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">User:</label>
                            <p id="editUserName" class="mb-1"></p>
                            <p id="editUserEmail" class="text-muted small"></p>
                        </div>
                        <div class="mb-3">
                            <label for="roleSelect" class="form-label fw-bold">Select New Role:</label>
                            <select class="form-select" id="roleSelect">
                                <option value="admin_manager">Admin Manager</option>
                                <option value="admin">Admin</option>
                                <option value="student">Student</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        <div class="alert alert-info small" role="alert">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Admin Manager:</strong> Full access including user management<br>
                            <strong>Admin:</strong> Can manage trips and students<br>
                            <strong>Student:</strong> Limited view-only access<br>
                            <strong>None:</strong> No access to the system
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="saveRoleBtn" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirm Clear Database Modal -->
        <div class="modal fade" id="confirmClearDBModal" tabindex="-1" aria-labelledby="confirmClearDBModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title" id="confirmClearDBModalLabel">
                            <i class="fas fa-exclamation-triangle me-2"></i>Confirm Database Clear
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <i class="fas fa-database fa-3x text-danger mb-3"></i>
                        <p class="lead text-danger fw-bold">WARNING: This action cannot be undone!</p>
                        <p class="text-muted">Are you sure you want to clear all databases? This will remove all students, trips, and related data.</p>
                        <div class="mt-4 text-start">
                            <label for="confirmTextInput" class="form-label">Type <strong>CONFIRM</strong> to proceed:</label>
                            <input type="text" class="form-control" id="confirmTextInput" placeholder="Type CONFIRM" autocomplete="off">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="confirmClearDB" class="btn btn-danger" disabled>Yes, Clear Databases</button>
                    </div>
                </div>
            </div>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
        <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
    </body>
</html>
