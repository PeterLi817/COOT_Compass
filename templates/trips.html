<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Trips</title>
        <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
        <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    </head>
    <body class="sb-nav-fixed">
        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <nav class="sb-sidenav accordion sb-sidenav-light" id="sidenavAccordion">

                    <div class="sidebar-logo-container" style="text-align: center; padding: 1.5rem 0;">
                        <a href="{{ url_for('main.groups') }}">
                            <img src="{{ url_for('static', filename='img/colby_logo.png') }}" alt="Colby logo" style="height: 50px; width: auto;">
                        </a>
                    </div>

                    <div class="sb-sidenav-menu">
                        <div class="nav">
                            <a class="nav-link" href="{{ url_for('main.trips') }}">
                                <div class="sb-nav-link-icon"><i class="fas fa-route"></i></div>
                                Trips
                            </a>
                            <a class="nav-link" href="{{ url_for('main.first_years') }}">
                                <div class="sb-nav-link-icon"><i class="fas fa-user-plus"></i></div>
                                First Years
                            </a>
                            <a class="nav-link" href="{{ url_for('main.groups') }}">
                                <div class="sb-nav-link-icon"><i class="fas fa-users"></i></div>
                                Groups
                            </a>
                        </div>
                    </div>

                    <div class="sb-sidenav-footer">
                        <a class="nav-link" href="{{ url_for('main.settings') }}">
                            <div class="sb-nav-link-icon"><i class="fas fa-cog"></i></div>
                            Settings
                        </a>
                    </div>
                </nav>
            </div>
            <div id="layoutSidenav_content">
                <main>
                    <div class="container-fluid px-4">
                        <h1 class="mt-4">Trips</h1>
                        {% with messages = get_flashed_messages() %}
                            {% if messages %}
                                <div style="color: red;">
                                {% for message in messages %}
                                    <p>{{ message }}</p>
                                {% endfor %}
                                </div>
                            {% endif %}
                        {% endwith %}
                        <div class="action-row">
                            <button class="btn btn-navy" type="button" data-bs-toggle="modal" data-bs-target="#uploadCSVModal">Upload CSV</button>
                            <button class="btn btn-navy" type="button" data-bs-toggle="modal" data-bs-target="#addTripModal"><i class="fas fa-plus me-1"></i> Add a trip</button>
                            <button class="btn btn-navy" type="button" data-bs-toggle="modal" data-bs-target="#removeTripModal">- Remove</button>
                            <!-- <button class="btn btn-navy">Move</button>
                            <button class="btn btn-navy">Swap</button> -->

                        </div>
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-table me-1"></i>
                                Trips
                            </div>
                            <div class="card-body">
                                <table id="datatablesSimple">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Trip Type</th>
                                            <th>Trip Name</th>
                                            <th>Address</th>
                                            <th>Capacity</th>
                                            <th>Water?</th>
                                            <th>Tents?</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for trip in trips %}
                                        <tr>
                                            <td>{{ trip.id }}</td>
                                            <td>{{ trip.trip_type }}</td>
                                            <td>{{ trip.trip_name }}</td>
                                            <td>{{ trip.address or '' }}</td>
                                            <td>{{ trip.capacity }}</td>
                                            <td>{{ 'Yes' if trip.water else 'No' }}</td>
                                            <td>{{ 'Yes' if trip.tent else 'No' }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary edit-trip-btn" data-trip-id="{{ trip.id }}" data-bs-toggle="modal" data-bs-target="#addTripModal">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        <div class="modal fade" id="addTripModal" tabindex="-1" aria-labelledby="addTripModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addTripModalLabel">Add New Trip</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="tripForm" action="{{ url_for('main.add_trip') }}" method="POST">
                        <input type="hidden" id="trip_db_id" name="trip_id" value="">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="trip_name" class="form-label">Trip Name*</label>
                                    <input type="text" class="form-control" id="trip_name" name="trip_name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="trip_type" class="form-label">Trip Type*</label>
                                    <select id="trip_type" name="trip_type" class="form-label" required>
                                        <option value="" disabled selected>Select an option</option>
                                        <option value="backpacking">Backpacking</option>
                                        <option value="canoeing">Canoeing</option>
                                        <option value="basecamp">Basecamp</option>
                                        <option value="classic maine camp">Classic Maine Camp</option>
                                        <option value="local exploration">Local Exploration</option>
                                        <option value="specialty basecamp">Specialty Basecamp</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="capacity" class="form-label">Capacity*</label>
                                    <input type="number" class="form-control" id="capacity" name="capacity" min="1" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" name="address">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" value="true" id="water" name="water">
                                        <label class="form-check-label" for="water">
                                            Water Trip
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" value="true" id="tent" name="tent">
                                        <label class="form-check-label" for="tent">
                                            Tent Trip
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">Fields marked with * are required.</small>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="tripSubmitBtn">Save Trip</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Upload CSV Modal with Column Matching -->
        <div class="modal fade" id="uploadCSVModal" tabindex="-1" aria-labelledby="uploadCSVModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #003366; color: white;">
                <h5 class="modal-title" id="uploadCSVModalLabel">Upload CSV File</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="csvMatchingForm" method="POST" enctype="multipart/form-data" action="{{ url_for('main.process_matched_trips_csv') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="csv_file" class="form-label">Select CSV File</label>
                        <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
                    </div>
                    
                    <div id="columnMatchingContainer" style="display: none;">
                        <h6 class="mb-3">Match CSV Columns to Database Fields</h6>
                        <div id="matchingRows"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" id="submitBtn" class="btn text-white" style="background-color:#003366; display: none;">Upload CSV</button>
                </div>
                </form>
            </div>
            </div>
        </div>

        <div class="modal fade" id="removeTripModal" tabindex="-1" aria-labelledby="removeTripModalLabel" aria-hidden="true">
           <div class="modal-dialog">
               <div class="modal-content">
                   <div class="modal-header">
                       <h5 class="modal-title" id="removeTripModalLabel">Remove Trip</h5>
                       <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                   </div>
                   <div class="modal-body">
                       <div class="mb-3">
                           <label for="removeTripSelect" class="form-label">Select Trip to Remove</label>
                           <select class="form-select" id="removeTripSelect" style="width: 100%;">
                               <option value="">Select a trip...</option>
                               {% for trip in trips %}
                                   <option value="{{ trip.id }}">
                                       {{ trip.trip_name }} ({{ trip.trip_type }})
                                   </option>
                               {% endfor %}
                           </select>
                       </div>
                   </div>
                   <div class="modal-footer">
                       <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                       <button type="button" class="btn btn-danger" id="openConfirmTripModalBtn">Next</button>
                   </div>
               </div>
           </div>
       </div>

       <div class="modal fade" id="confirmRemoveTripModal" tabindex="-1" aria-labelledby="confirmRemoveTripModalLabel" aria-hidden="true">
           <div class="modal-dialog">
               <div class="modal-content">
                   <div class="modal-header">
                       <h5 class="modal-title" id="confirmRemoveTripModalLabel">Confirm Removal</h5>
                       <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                   </div>
                   <div class="modal-body">
                       <p>Are you sure you want to remove this trip?</p>
                       <h4 class="text-center text-danger" id="tripNameToRemove"></h4>
                       <p class="text-center text-muted">This action cannot be undone.</p>
                   </div>
                   <div class="modal-footer">
                       <form action="{{ url_for('main.remove_trip') }}" method="POST" class="w-100">
                           <input type="hidden" name="trip_id" id="tripIdToRemove">

                           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                           <button type="submit" class="btn btn-danger float-end">Yes, Remove Trip</button>
                       </form>
                   </div>
               </div>
           </div>
       </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
        <script src="{{ url_for('static', filename='js/datatables-simple-demo.js') }}"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script>
            // Make trip data available globally
            window.tripsData = {{ trips_data_json|safe }};
        </script>
        <script src="{{ url_for('static', filename='js/trips.js') }}"></script>

        <!-- CSV Column Matching Script for Trips -->
        <script>
        const tripDbFields = [
            { value: '', label: '-- Skip Column --' },
            { value: 'trip_name', label: 'Trip Name' },
            { value: 'trip_type', label: 'Trip Type' },
            { value: 'capacity', label: 'Capacity' },
            { value: 'address', label: 'Address' },
            { value: 'water', label: 'Water' },
            { value: 'tent', label: 'Tent' }
        ];

        document.getElementById('csv_file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const text = event.target.result;
                parseCSV(text);
            };
            reader.readAsText(file);
        });

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return;

            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }

            const headerLine = parseCSVLine(lines[0]);
            const csvColumns = headerLine.map(col => col.replace(/^"|"$/g, '').trim());

            showColumnMatching(csvColumns);
        }

        function showColumnMatching(csvColumns) {
            const container = document.getElementById('matchingRows');
            container.innerHTML = '';

            csvColumns.forEach((csvCol, index) => {
                const row = document.createElement('div');
                row.className = 'mb-3';
                
                const label = document.createElement('label');
                label.className = 'form-label';
                label.textContent = csvCol;
                
                const select = document.createElement('select');
                select.className = 'form-select';
                select.name = csvCol;
                select.id = `match_${index}`;
                
                let autoMatch = '';
                const csvLower = csvCol.toLowerCase().replace(/[^a-z0-9]/g, '_');
                if (csvLower.includes('trip') && csvLower.includes('name')) autoMatch = 'trip_name';
                else if (csvLower.includes('trip') && csvLower.includes('type')) autoMatch = 'trip_type';
                else if (csvLower.includes('capacity')) autoMatch = 'capacity';
                else if (csvLower.includes('address')) autoMatch = 'address';
                else if (csvLower.includes('water')) autoMatch = 'water';
                else if (csvLower.includes('tent')) autoMatch = 'tent';

                tripDbFields.forEach(field => {
                    const option = document.createElement('option');
                    option.value = field.value;
                    option.textContent = field.label;
                    if (field.value === autoMatch) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                row.appendChild(label);
                row.appendChild(select);
                container.appendChild(row);
            });

            // Add Action dropdown at the end
            const actionRow = document.createElement('div');
            actionRow.className = 'mb-3';
            
            const actionLabel = document.createElement('label');
            actionLabel.className = 'form-label';
            actionLabel.textContent = 'Action';
            
            const actionSelect = document.createElement('select');
            actionSelect.className = 'form-select';
            actionSelect.name = 'importMode';
            actionSelect.id = 'importMode';
            actionSelect.required = true;
            
            const addOption = document.createElement('option');
            addOption.value = 'add';
            addOption.textContent = 'Add New Trips';
            actionSelect.appendChild(addOption);
            
            const updateOption = document.createElement('option');
            updateOption.value = 'update';
            updateOption.textContent = 'Update Existing Trips';
            actionSelect.appendChild(updateOption);
            
            actionRow.appendChild(actionLabel);
            actionRow.appendChild(actionSelect);
            container.appendChild(actionRow);

            document.getElementById('columnMatchingContainer').style.display = 'block';
            document.getElementById('submitBtn').style.display = 'inline-block';
        }

        document.getElementById('csvMatchingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';
            
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`CSV uploaded successfully!\nAdded: ${data.added}, Updated: ${data.updated}, Skipped: ${data.skipped}`);
                    if (data.errors && data.errors.length > 0) {
                        console.warn('Errors:', data.errors);
                    }
                    const modal = bootstrap.Modal.getInstance(document.getElementById('uploadCSVModal'));
                    modal.hide();
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Failed to upload CSV'));
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Upload CSV';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error uploading CSV: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload CSV';
            });
        });

        document.getElementById('uploadCSVModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('csv_file').value = '';
            document.getElementById('columnMatchingContainer').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
        });
        </script>
    </body>
</html>
